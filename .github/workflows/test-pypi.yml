# TraceSmith - Test PyPI Release
# Manual workflow to test publishing to TestPyPI

name: Test PyPI Release

on:
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (e.g., rc1, dev1)'
        required: false
        default: ''

jobs:
  build_test:
    name: Build for Test PyPI
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Update version if suffix provided
        if: inputs.version_suffix != ''
        run: |
          # Update version in files
          VERSION_SUFFIX="${{ inputs.version_suffix }}"
          sed -i "s/version = \"0.7.1\"/version = \"0.7.1${VERSION_SUFFIX}\"/" pyproject.toml
          sed -i "s/version='0.7.1'/version='0.7.1${VERSION_SUFFIX}'/" setup.py
      
      - name: Build sdist only (for testing)
        run: python -m build --sdist
      
      - name: Check dist
        run: twine check dist/*
      
      - name: Upload to Test PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          twine upload --repository testpypi dist/*
      
      - name: Test installation from Test PyPI
        run: |
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ tracesmith
          python -c "import tracesmith; print(f'Version: {tracesmith.__version__}')"

